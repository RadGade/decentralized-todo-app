<html>
<head>
    <meta charset="UTF-8">
</head>    
<body>
    <h1>Todo App</h1>
    <input onchange="addTodo(this)" type="text">
    <ul id="todoList">
    </ul>

    <style>
        .completed {text-decoration: line-through;}
    </style>

    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script>
        var gun = Gun();
        var gunAppGraph = gun.get('todos');
        var localData = {};
        
        function addTodo(element) {
            console.log(`setting "${element.value}" to gun graph...`);
            var date = new Date();
            gunAppGraph.set({thing: element.value, timeCreated: date.toString(),status: 'active'});
            element.value = '';
        };
        
        gunAppGraph.map().on(function(node, nodeID){
            console.log(`${nodeID} was updated! Updating local data...`);
            localData[nodeID] = node;
            renderList(localData);
        });

        function renderList(todos) {
            console.log('re-rendering UI...');
            var todoList = document.getElementById("todoList");
            todoList.innerHTML = '';
            var todosHTML = '';
            for (let [nodeID, node] of Object.entries(todos)) {
                if (node !== null) {
                    console.log('rendering this object');
                    console.log(node);
                    todosHTML += `<li id="${nodeID}" class="${node.status}">${node.timeCreated} ::: ${node.thing} <button onclick="changeStatus(this)">Change Status</button><button onclick="deleteThing(this)">Delete</button></li>`;
                }
            }
            todoList.innerHTML = todosHTML;
        }

        function changeStatus(element) {
            var parent = element.parentElement;
            var nodeID = parent.id;
            console.log(`changing status of "${nodeID}" in gun graph...`);
            if (parent.classList.contains('completed')) {
                gunAppGraph.get(nodeID).put({status: 'active'});
            } else {
                gunAppGraph.get(nodeID).put({status: 'completed'});
            }
        }

        function deleteThing(element) {
            var parent = element.parentElement;
            var nodeID = parent.id;
            console.log(`tombstoning "${nodeID}" in gun graph...`);
            gunAppGraph.get(nodeID).put(null);
        }

    </script>
</body>
</html>
